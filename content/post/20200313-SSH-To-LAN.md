---
title: "SSH花式连到内网"
date: 2020-00-00
description: ""
tags: ["linux","ssh","运维","vpn","内网"]
categories: ["运维"]
---
# SSH花式连到内网

## 0x01 背景

疫情期间远程办公，自然少不了需要连接到公司内网的服务器跑程序。SSH是一种常用的连接到内网的方式，几乎能做到所有连接内网的操作。下面作者将对几种连接到内网的使用情况做一些示例。

## 0x02 网络拓扑

下面将对网络中的几台机器的网络拓扑做说明。
> IP均作匿名化处理

- 个人笔记本1
  - 主机名：PC1
  - 位置： 公网
  - IP：不重要
- 跳板机
  - 主机名：proxy.test.com
  - ssh:
    - 端口: 5022
    - 用户名: user
  - IP/域名
    - 公网: proxy.test.com
    - 内网: 192.168.8.10
- 服务器1
  - 主机名: srv1
  - ssh
    - 端口: 818
    - 用户名: user
  - IP
    - 内网：192.168.8.18

## 0x03 基础知识

- ssh
  - ssh 端口转发
  - ssh config文件配置
  - ssh 密钥设置
- 代理服务器

## 0x04 工具列表
### 0x041 本地PC
- 如果是windows
  - 安装git-bash
  
- 如果是MacOS或者是Linux
  - 使用本地自带的ssh

### 0x042 企业服务器
需要配置好SSH服务器

## 0x05 ssh端口转发的基本操作以及通过企业网络访问网站

### 0x051 适用情况
本方法可以适用于访问

- 企业内部搭建的网站
- 必须企业IP授权才能访问的网站（如论文检索网站）

### 0x052 步骤
1. 执行ssh动态转发命令

```bash
# 在PC1上执行
ssh -D 10824 user@proxy.test.com -p 5022
```

上面的命令是在PC1本地开放端口10824，该端口作为一个Sock代理服务器，使用此代理可以通过企业内网访问网络

2. 浏览器配置代理

在谷歌Chrome浏览器中配置Proxy SwitchyOmega。  
添加新情景模式，类型为代理服务器。  
配置代理协议为`sock4`,服务器和端口分别为`localhost`,`10824`  

现在就能在浏览器中访问只有企业内部才可访问的网站了。

### 0x053 优化

1. 速度优化

SSH添加**-C**参数可以实现数据包的压缩，对于大量数据的传输会提高速度。
```bash
ssh -C -D 10824 user@proxy.test.com -p 5022
```
2. bug调试

添加**-v**参数能够显示连接过程中的详细信息，出现错误后可以自行调试。
```bash
ssh -vC -D 10824 user@proxy.test.com -p 5022
```
3. 不打开终端

添加**-N**参数可以不打开终端界面。
```bash
ssh -vNC -D 10824 user@proxy.test.com -p 5022
```
4. 添加公钥访问，减少密码输入，并提高安全性

```bash
ssh-keygen # 生成密钥对
# 添加私钥到服务器
ssh-copy-id -i ~/.ssh/id_rsa.pub user@proxy.test.com -p 5022
# 此时连接可以不用密码
ssh -vNC -D 10824 user@proxy.test.com -p 5022
```

5. 保存为config，减少记忆量

在用户目录的.ssh下创建config文件,填入以下内容

```bash
Host proxy # 别名
  HostName proxy.test.com # 远程跳板机的域名或者IP
  Port 5022
  User user 
  IdentityFile "~/.ssh/id_rsa" # 私钥
  DynamicForward 10824 # 动态转发
  Compression yes # 压缩
```

现在使用下面的命令即可访问
```
ssh -vN proxy
```

6. 防止中断
 
服务器默认会把不活动的ssh断掉，我们可以在config文件中加入keepalive选项来防止中断

```
ServerAliveInterval 180
ServerAliveCountMax 2
```
这个配置的意思是每180秒发送一次keepalive的空包，如果两次失败就会断掉连接

```
# 完整.ssh/config
ServerAliveInterval 180
ServerAliveCountMax 2
Host proxy # 别名
  HostName proxy.test.com # 远程跳板机的域名或者IP
  Port 5022
  User user 
  IdentityFile "~/.ssh/id_rsa" # 私钥
  DynamicForward 10824 # 动态转发
  Compression yes # 压缩
```

7. 自动重播

可以搭配上自动重新连接的操作，来达到PC休眠苏醒后也能及时连接的功能。

使用while循环来重新连接

```bash
while :; do ssh -vN proxy ; done
```

8. 制作快捷方式(Windows)
  1. 在桌面上新建快捷方式
   
   目标设定为 
   ``` bash
   "<绝对路径>\git-bash.exe" -c "while :; do ssh -vN proxy; done"
   ```
   注意设置为git-bash的绝对路径。
  2. 可以拖动该快捷方式到任务栏
  3. 或者将快捷方式放入开始菜单的`启动`文件夹，实现开机自启。

## 0x06 访问内网服务器ssh
大家可以想到的方式是先访问跳板机，然后再在跳板机上进行ssh连接到srv1。但是这样需要在跳板机proxy上放置自己的私钥，不安全。

作者使用了ssh提供的ssh代理的功能。

```bash
ssh -o "ProxyCommand ssh user@proxy.test.com -p 5022 -W %h:%p" user@192.168.8.18 -p 818
```

**-o**:是SSH 选项。本步骤使用了`ProxyCommand`的选项，它可以做到通过proxy.test.com这台跳板机访问srv1(192.168.8.18)。

### 优化
在上一节0x05中，我们配置了ssh config文件，本步骤中可以继续用。

命令可以优化为：

```bash
ssh -o "ProxyCommand ssh proxy -W %h:%p" user@192.168.8.18 -p 818
```

### 继续优化
在ssh config中加入srv1

```
# 加入0x05部分的完整ssh config
Host srv1
 HostName 192.168.8.18
 User user
 port 818
 IdentityFile "~/.ssh/id_rsa"
 ProxyCommand ssh proxy -W %h:%p # 这个是核心
```

现在可以使用下面的终极简化命令访问srv1
```bash
ssh srv1
```

## 0x07 本地访问企业内部数据库端口
假设srv1上面有个redis数据库服务，端口为6379，只能从srv1的本地访问。

现在本地的PC1机器在测试程序，也想直接访问这个端口。

这时候可以用到本地端口转发的功能。命令格式为：
```bash
# 格式
ssh -L <本地ip>:<本地端口>:<远程ip>:<远程端口> <服务器>
```

在本情况下的命令为。
```bash
ssh -L 6379:6379 srv1

```
这时候访问127.0.0.1的6379端口即可连到redis数据库。

作者比较喜欢打开调试、压缩和禁止连到终端。
```bash
ssh -vNCL 6379:6379 srv1
```

此转发同样可以写入配置文件
```
Host srv1
 HostName 192.168.8.18
 User user
 port 818
 IdentityFile "~/.ssh/id_rsa"
 ProxyCommand ssh proxy -W %h:%p # 这个是核心
 LocalForward 6379 6379
 Compression yes
```

### 0x071 保持服务器名称不变
开发的时候会把服务器的名称固定写到配置文件中，在本地调试的时候为了模拟服务器环境，一般不会更改配置文件。

如果还想以 `srv1:6379` 连接到redis数据库，可以按如下操作。

1. 修改hosts文件
   
添加下面的一行到hosts文件
```
127.0.8.18 srv1
```

2. 修改.ssh/config文件
把srv1下的LocalForward修改为
```
LocalForward 127.0.8.18:6379 6379
```

此时PC1本地可以通过`srv1:6379`连接到redis数据库。

## 0x08 让服务器能访问本地测试环境的数据库

## 0x09 使用VSCode远程编程调试

## 0x10 映射服务器文件夹

## 0x11 访问同在远程的同事的本地服务

--------
- **版权声明**：本文为 m2kar 的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
- **作者**: m2kar
- **打赏链接**: [欢迎打赏m2kar](http://m2kar-cn.mikecrm.com/wy97haW)
- **邮箱**: [m2kar.cn#gmail.com](mailto:m2kar.cn@gmail.com)
- **主页**: [m2kar.cn](https://m2kar.cn)
- **Github**: [github.com/m2kar](https://github.com/m2kar)
- **CSDN**: [M2kar的专栏](https://blog.csdn.net/still_night)
